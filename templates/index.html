{% extends 'base.html' %}

{% block title %}
{% endblock title %}



{% block content %}
<div class="overlay modal" id="gameModal">

    <a id="modalClose" type="reset" class="close-btn" href="/">
        <svg xmlns="http://www.w3.org/2000/svg" width="15" height="16" viewBox="0 0 15 16" fill="none">
            <path opacity="0.5" d="M1 1.25L7.75 8M14.5 14.75L7.75 8M7.75 8L1 14.75M7.75 8L14.5 1.25" stroke="white" />
        </svg>
    </a>

    <div class="modal-content">
        <img id="modalPreview" src="{{ request.url_root ~ game.preview if game and game.preview else '' }}">

        <div class="head">
            <h1 id="modalTitle">{{ game.title if game else '' }}</h1>
            <div id="modalDownloads">
                {% if game and game.game_downloads %}
                    {% for d in game.game_downloads %}
                        <div>
                            {{ loop.index }}. {{ d.title or 'Без названия' }} —
                            <a href="{{ url_for('download_file', filename=d.file_link) }}">Скачать</a>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>

        <p id="modalDescription">{{ game.game_info.description if game else '' }}</p>
        <h3>Загрузки</h3>
    </div>
</div>

<style>

</style>





<h2>Недавно обновлено</h2>
<div class="library-wr flex gap-8">
    <div class="object-wr">
        {% for game in latest_shares %}
        <a href="/game/{{ game.link }}">
            {{ game.title }}

            {% if game.game_downloads and game.game_downloads|length > 0 %}
                <span class="file-size">
                    {{ game.game_downloads[0].file_size|filesize }}
                </span>
                
            {% else %}
                <span class="file-size">
                    Нет файлов
                </span>
            {% endif %}

            {% if game.game_info.app_type == 'app' %}
            <img src="{{ url_for('static', filename='icons/terminal.svg') }}">
            {% endif %}
            {% if game.game_info.app_type == 'game' %}
            <img src="{{ url_for('static', filename='icons/joystick.svg') }}">
            {% endif %}
        </a>

        {% endfor %}
    </div>
</div>

<h2>Библиотека приложений</h2>
<div class="library-wr flex gap-8">
    <div class="object-wr selectable" data-category="shares">
        {% for app in shares %}
        <a href="#" data-game-link="{{ app.link }}">
        <!-- <a href="/game/{{ app.link }}"> -->
            {{ app.title }}

            {% if app.game_downloads and app.game_downloads|length > 0 %}
                <span class="file-size">
                    {{ app.game_downloads[0].file_size|filesize }}
                </span>
                
            {% else %}
                <span class="file-size">
                    Нет файлов
                </span>
            {% endif %}

            {% if app.game_info.app_type == 'app' %}
            <img src="{{ url_for('static', filename='icons/terminal.svg') }}">
            {% endif %}
            {% if app.game_info.app_type == 'game' %}
            <img src="{{ url_for('static', filename='icons/joystick.svg') }}">
            {% endif %}

        </a>


        {% endfor %}
    </div>

    <div class="object-wr selectable" data-category="games">
        {% for game in games %}
        <a href="/game/{{ game.link }}">
            {{ game.title }}

            {% if game.game_downloads and game.game_downloads|length > 0 %}
                <span class="file-size">
                    {{ game.game_downloads[0].file_size|filesize }}
                </span>
                
            {% else %}
                <span class="file-size">
                    Нет файлов
                </span>
            {% endif %}
        </a>

        {% endfor %}
    </div>


    <div class="object-wr selectable" data-category="apps">
        {% for app in apps %}
        <a href="/game/{{ app.link }}">
            {{ app.title }}
            {{ app.game_downloads[0] }}
            {% if app.game_downloads and app.game_downloads|length > 0 %}
                <span class="file-size">
                    {{ app.game_downloads[0].file_size|filesize }}
                </span>
                
            {% else %}
                <span class="file-size">
                    Нет файлов
                </span>
            {% endif %}
        </a>

        {% endfor %}
    </div>

    <div class="category-wr">
        <a href="#" class="shares" data-category="shares">
            <img src="{{ url_for('static', filename='icons/close.svg') }}" alt="ALL">
        </a>
        <a href="#" data-category="games">
            <img src="{{ url_for('static', filename='icons/joystick.svg') }}" alt="GAMES">
        </a>
        <a href="#" data-category="apps">
            <img src="{{ url_for('static', filename='icons/terminal.svg') }}" alt="APPS">
        </a>
    </div>
</div>



<!-- <h1>Файлы</h1>
<div class="object-wr">
    {% for file in files %}
    <a href="/file/{{ file.link }}">{{ file.title }}</a>
    {% endfor %}
</div> -->

<h2>Юзеры</h2>
<div class="library-wr flex gap-8">
    <div class="object-wr users">
        {% for user in users %}
        <a href="/user/{{ user["username"] }}">{{user["username"]}}</a>
        {% endfor %}
    </div>
</div>

<script>
    $(document).ready(function () {
    const $blocks = $('.object-wr.selectable');
    const $links = $('.category-wr a');

    function showCategory(category) {
        $blocks.each(function () {
            const $block = $(this);
            $block.toggle($block.data('category') === category);
        });

        $links.removeClass('active');
        $links.filter(`[data-category="${category}"]`).addClass('active');
    }

    $links.on('click', function (e) {
        e.preventDefault();
        const category = $(this).data('category');
        showCategory(category);
    });

    showCategory('shares');
});
</script>
<script>
document.querySelectorAll('a[data-game-link]').forEach(link => {
  link.addEventListener('click', async e => {
    e.preventDefault();
    const gameLink = link.getAttribute('data-game-link');
    const res = await fetch(`/api/game/${gameLink}`);
    if (!res.ok) {
      alert("Ошибка загрузки игры");
      return;
    }
    const data = await res.json();

    // Заполняем модалку
    document.getElementById('modalTitle').textContent = data.title;
    document.getElementById('modalPreview').src = data.preview ? location.origin + data.preview : '';
    document.getElementById('modalDescription').textContent = data.description;

    // Загрузки
    const downloadsDiv = document.getElementById('modalDownloads');
    downloadsDiv.innerHTML = '';
    data.downloads.forEach((d, i) => {
      const div = document.createElement('div');
      div.innerHTML = `${i+1}. ${d.title} — <a href="${d.file_link}">Скачать</a>`;
      downloadsDiv.appendChild(div);
    });

    // Показываем модалку
    document.getElementById('gameModal').style.display = 'flex';
  });
});

// Закрытие попапа
document.getElementById('modalClose').addEventListener('click', () => {
  document.getElementById('gameModal').style.display = 'none';
});

// Закрытие при клике вне модального окна
window.addEventListener('click', e => {
  if (e.target == document.getElementById('gameModal')) {
    document.getElementById('gameModal').style.display = 'none';
  }
});
</script>

{% endblock content %}