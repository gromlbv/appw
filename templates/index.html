{% extends 'base.html' %}

{% block title %}
{% endblock title %}



{% block content %}


<div class="card-wrapper flex gap-8">
    <div class="card head">
        <div class="flex-cl gap-12">
            <a href="/add" class="orange height-fill">
                <img class="original icons" src="{{ url_for('static', filename='icons/plus-black.svg') }}" alt="">
                Добавить...
            </a>
            {% if not session.get('token') %}
            <a href="/account/login" class="height-fill">
                <img class="original icons" src="{{ url_for('static', filename='icons/person-sketch.svg') }}" alt="">
                Войти в аккаунт
            </a>
            {% else %}
            <a href="/account/me" class="height-fill">
                <img class="original icons" src="{{ url_for('static', filename='icons/person-sketch.svg') }}" alt="">
                Открыть профиль
            </a>
            {% endif %}
        </div>

        <div class="flex-end gap-12 flex-grow">
            <a class="bigger">
                Коллекции
                <img class="original graphs" src="{{ url_for('static', filename='icons/heart.svg') }}" alt="">
                <span class="bottom">
                    В РАЗРАБОТКЕ
                </span>
            </a>
            <a class="bigger" href="/graphs">
                Graphs
                <img class="original graphs" src="{{ url_for('static', filename='icons/graphs.svg') }}" alt="">
                <span class="bottom">
                    Просматривайте игры и приложения в виде графиков
                </span>
            </a>
        </div>
    </div>
</div>


<div id="context-menu">
    <button class="menu-item first-child play">
        <div class="img-wr">
            <img src="{{ url_for('static', filename='icons/play-context.svg') }}">
        </div>
        <span class="main">Играть</span>
    </button>
    <button class="menu-item first-child download">
        <div class="img-wr">
            <img src="{{ url_for('static', filename='icons/download-context.svg') }}">
        </div>
        <span class="main">Скачать игру</span>
    </button>
    <button class="menu-item share">
        <div class="img-wr">
            <img src="{{ url_for('static', filename='icons/share-context.svg') }}">
        </div>
        <span class="main">Поделиться</span>
    </button>

    <div class="divider"></div>

    <button class="menu-item new-tab">
        <div class="img-wr"></div>
        <span class="main">Открыть в новой вкладке</span>
    </button>
</div>

<script>
let $menu = $('#context-menu');
let $currentTarget = null;


function showContextMenu(x, y) {
    const $menu = $('#context-menu');
    
    $menu.css({
        left: x,
        top: y,
        opacity: 1,
        pointerEvents: 'auto',
        position: 'fixed'
    });

    console.log('Show menu at:', x, y);
}


function hideContextMenu() {
    $menu.css({ opacity: 0, pointerEvents: 'none' });
}
$(window).on('scroll', function() {
    hideContextMenu();
});

function bindContextHandlers() {
    $(document).on('contextmenu', function(e) {
        const $target = $(e.target).closest('.custom-context');
        if ($target.length) {
            e.preventDefault();
            $currentTarget = $target;
            updateContextMenu($target);

            showContextMenu(e.clientX, e.clientY);

        } else {
            hideContextMenu();
        }
    });

    $(window).on('scroll', function() {
        hideContextMenu();
    });

    $(document).on('click', function(e) {
        if (!$(e.target).closest('#context-menu').length) hideContextMenu();
    });

    $menu.on('click', '.play', function() {
        if (!$currentTarget) return;
        const url = $currentTarget.data('play-url');
        if (url) window.location.href = url;
    });

    $menu.on('click', '.download', function() {
        if (!$currentTarget) return;
        const url = $currentTarget.data('download-url');
        if (url) window.location.href = url;
    });

    $menu.on('click', '.share', function() {
        if (!$currentTarget) return;
        const link = $currentTarget.data('share-link');
        if (link) {
            navigator.clipboard.writeText(link).then(() => {
                alert('Ссылка скопирована');
            });
        }
    });

    $menu.on('click', '.new-tab', function() {
        if (!$currentTarget) return;
        const url = $currentTarget.data('open-url');
        if (url) window.open(url, '_blank');
    });
}

function updateContextMenu($target) {
    const hasPlay = $target.data('has-play') === 1 || $target.data('has-play') === '1';
    $('.menu-item.play').toggle(hasPlay);
    $('.menu-item.download').toggle(!hasPlay);
}

bindContextHandlers();
</script>
<h2>Недавно обновлено</h2>
<div class="card-wrapper flex gap-8">
    <div class="card">
        {% for app in latest_shares %}
            {% set show_update_at = true %}
            {% include 'partials/_game_card.html' %}
        {% endfor %}
    </div>
</div>

<h2>Библиотека приложений</h2>
<div class="card-wrapper flex gap-8">
    <div class="card selectable" data-category="shares">
        {% for app in shares %}
            {% include 'partials/_game_card.html' %}
        {% endfor %}
    </div>

    <div class="card selectable" data-category="games">
        {% for app in games %}
            {% include 'partials/_game_card.html' %}
        {% endfor %}
    </div>


    <div class="card selectable" data-category="apps">
        {% for app in apps %}
            {% include 'partials/_game_card.html' %}
        {% endfor %}
    </div>

    <div class="category-wr">
        <a href="#" class="shares" data-category="shares">
            <img src="{{ url_for('static', filename='icons/close.svg') }}" alt="ALL">
        </a>
        <a href="#" data-category="games">
            <img src="{{ url_for('static', filename='icons/joystick.svg') }}" alt="GAMES">
        </a>
        <a href="#" data-category="apps">
            <img src="{{ url_for('static', filename='icons/terminal.svg') }}" alt="APPS">
        </a>
    </div>
</div>



<!-- <h1>Файлы</h1>
<div class="card">
    {% for file in files %}
    <a href="/file/{{ file.link }}">{{ file.title }}</a>
    {% endfor %}
</div> -->

<h2>Юзеры</h2>
<div class="card-wrapper flex gap-8">
    <div class="card users">
        {% for user in users %}
        <a href="/user/{{ user["username"] }}">{{user["username"]}}</a>
        {% endfor %}
    </div>
</div>

<script>
    $(document).ready(function () {
        const $blocks = $('.card.selectable');
        const $links = $('.category-wr a');

        function showCategory(category) {
            $blocks.each(function () {
                const $block = $(this);
                $block.toggle($block.data('category') === category);
            });

            $links.removeClass('active');
            $links.filter(`[data-category="${category}"]`).addClass('active');
        }

        $links.on('click', function (e) {
            e.preventDefault();
            const category = $(this).data('category');
            showCategory(category);
        });

        showCategory('shares');
    });
</script>



{% endblock content %}